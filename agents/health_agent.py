"""
å¥åº·é¡¾é—®Agent

æä¾›å¥åº·å’¨è¯¢ã€è¿åŠ¨å»ºè®®ã€é¥®é£ŸæŒ‡å¯¼ç­‰æœåŠ¡ã€‚
è¿™æ˜¯ä¸€ä¸ªå…·æœ‰é«˜å•†ä¸šä»·å€¼çš„Agentï¼Œé€‚ç”¨äºŽå¥åº·ç®¡ç†é¢†åŸŸã€‚
"""
from typing import Dict, Any, Optional
from datetime import datetime
from src.agents import BaseAgent, Message, ChatContext, AgentResponse, SQLiteMemoryStore


class HealthAgent(BaseAgent):
    """
    å¥åº·é¡¾é—®Agent - æä¾›å¥åº·ç”Ÿæ´»æŒ‡å¯¼
    
    ä¸“é•¿é¢†åŸŸ:
    - å¥åº·å’¨è¯¢ï¼šå¸¸è§å¥åº·é—®é¢˜è§£ç­”
    - è¿åŠ¨æŒ‡å¯¼ï¼šå¥èº«è®¡åˆ’ã€è¿åŠ¨å»ºè®®
    - é¥®é£Ÿç®¡ç†ï¼šè¥å…»çŸ¥è¯†ã€é¥®é£Ÿè§„åˆ’
    - ç¡çœ æ”¹å–„ï¼šç¡çœ è´¨é‡ä¼˜åŒ–å»ºè®®
    - å¿ƒç†å¥åº·ï¼šåŽ‹åŠ›ç®¡ç†ã€æƒ…ç»ªè°ƒèŠ‚
    
    é€‚ç”¨åœºæ™¯:
    - "æœ€è¿‘è€æ˜¯å¤±çœ æ€Žä¹ˆåŠžï¼Ÿ"
    - "å¸®æˆ‘åˆ¶å®šä¸€ä¸ªå‡è‚¥è®¡åˆ’"
    - "å¦‚ä½•æ”¹å–„ä¹…åå¸¦æ¥çš„é¢ˆæ¤Žé—®é¢˜ï¼Ÿ"
    """
    
    def __init__(self, memory_store=None, llm_provider=None):
        """
        åˆå§‹åŒ–å¥åº·é¡¾é—®Agent
        """
        self._name = "HealthAgent"
        self._description = (
            "æä¾›å¥åº·ç”Ÿæ´»æŒ‡å¯¼å’Œå»ºè®®ã€‚"
            "æ¶µç›–è¿åŠ¨å¥èº«ã€é¥®é£Ÿè¥å…»ã€ç¡çœ æ”¹å–„ç­‰é¢†åŸŸï¼Œ"
            "å¸®åŠ©ç”¨æˆ·å»ºç«‹å¥åº·çš„ç”Ÿæ´»æ–¹å¼ã€‚"
        )
        self._memory = memory_store or SQLiteMemoryStore()
        self._llm_provider = llm_provider
        
        # å¥åº·ç›¸å…³å…³é”®è¯
        self._health_keywords = [
            # èº«ä½“å¥åº·
            "å¥åº·", "èº«ä½“", "ä½“æ£€", "ç—‡çŠ¶", "ç–¾ç—…", "é¢„é˜²",
            "health", "body", "symptom", "disease", "prevention",
            
            # è¿åŠ¨å¥èº«
            "è¿åŠ¨", "å¥èº«", "é”»ç‚¼", "å‡è‚¥", "å‡è„‚", "å¢žè‚Œ",
            "exercise", "workout", "fitness", "gym", "weight loss",
            "è·‘æ­¥", "æ¸¸æ³³", "ç‘œä¼½", "åŠ›é‡è®­ç»ƒ",
            
            # é¥®é£Ÿè¥å…»
            "é¥®é£Ÿ", "è¥å…»", "å¡è·¯é‡Œ", "è›‹ç™½è´¨", "ç»´ç”Ÿç´ ",
            "diet", "nutrition", "calories", "protein", "vitamin",
            "åƒä»€ä¹ˆ", "é£Ÿç‰©", "å¥åº·é¥®é£Ÿ",
            
            # ç¡çœ 
            "ç¡çœ ", "å¤±çœ ", "ç¡ä¸å¥½", "ç¡ä¸ç€", "ç†¬å¤œ",
            "sleep", "insomnia", "tired", "fatigue",
            
            # å¸¸è§é—®é¢˜
            "å¤´ç—›", "é¢ˆæ¤Ž", "è…°ç—›", "çœ¼ç›", "è§†åŠ›",
            "headache", "neck", "back pain", "eyes",
            
            # å¿ƒç†å¥åº·
            "åŽ‹åŠ›", "ç„¦è™‘", "æ”¾æ¾", "å†¥æƒ³",
            "stress", "anxiety", "relaxation", "meditation",
        ]
        
        # ç³»ç»Ÿæç¤ºè¯
        self._system_prompt = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¥åº·ç”Ÿæ´»é¡¾é—®ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„å¥åº·ç®¡ç†çŸ¥è¯†ã€‚

ä½ çš„èŒè´£ï¼š
1. æä¾›ç§‘å­¦çš„å¥åº·ç”Ÿæ´»å»ºè®®
2. è§£ç­”è¿åŠ¨å¥èº«ã€é¥®é£Ÿè¥å…»ç›¸å…³é—®é¢˜
3. å¸®åŠ©ç”¨æˆ·æ”¹å–„ç¡çœ è´¨é‡
4. æä¾›åŽ‹åŠ›ç®¡ç†å’Œæ”¾æ¾å»ºè®®

é‡è¦åŽŸåˆ™ï¼š
- å§‹ç»ˆå¼ºè°ƒ"å¦‚æœ‰ä¸¥é‡ç—‡çŠ¶è¯·åŠæ—¶å°±åŒ»"
- ä¸æä¾›åŒ»ç–—è¯Šæ–­ï¼Œåªåšå¥åº·æŒ‡å¯¼
- å»ºè®®å› äººè€Œå¼‚ï¼Œæé†’ç”¨æˆ·æ ¹æ®è‡ªèº«æƒ…å†µè°ƒæ•´
- æŽ¨èå¾ªåºæ¸è¿›çš„æ”¹å˜æ–¹å¼

å›žå¤é£Žæ ¼ï¼š
- æ¸©æš–ã€ä¸“ä¸šã€æœ‰é¼“åŠ±æ€§
- æä¾›å…·ä½“å¯è¡Œçš„å»ºè®®
- é€‚å½“ä½¿ç”¨emojiå¢žåŠ äº²å’ŒåŠ›"""

    @property
    def name(self) -> str:
        return self._name
    
    @property
    def description(self) -> str:
        return self._description
    
    def can_handle(self, message: Message, context: ChatContext) -> float:
        """åˆ¤æ–­æ˜¯å¦èƒ½å¤„ç†æ­¤æ¶ˆæ¯"""
        if message.has_mention(self.name):
            return 1.0
        
        content = message.content.lower()
        keyword_matches = sum(1 for kw in self._health_keywords if kw in content)
        
        if keyword_matches >= 3:
            return 0.9
        elif keyword_matches == 2:
            return 0.75
        elif keyword_matches == 1:
            return 0.55
        
        return 0.0
    
    def respond(self, message: Message, context: ChatContext) -> AgentResponse:
        """ç”Ÿæˆå¥åº·å’¨è¯¢å›žå¤"""
        user_memory = self.memory_read(message.user_id)
        interaction_count = user_memory.get("interaction_count", 0)
        
        content = message.get_clean_content().lower()
        
        # è¯†åˆ«ä¸»é¢˜å¹¶ç”Ÿæˆå“åº”
        if any(word in content for word in ["è¿åŠ¨", "å¥èº«", "é”»ç‚¼", "å‡è‚¥", "å¢žè‚Œ", "gym"]):
            topic = "fitness"
            response = self._respond_fitness(message, user_memory)
        elif any(word in content for word in ["é¥®é£Ÿ", "è¥å…»", "åƒ", "é£Ÿç‰©", "å¡è·¯é‡Œ"]):
            topic = "nutrition"
            response = self._respond_nutrition(message, user_memory)
        elif any(word in content for word in ["ç¡çœ ", "å¤±çœ ", "ç¡ä¸å¥½", "ç†¬å¤œ", "sleep"]):
            topic = "sleep"
            response = self._respond_sleep(message, user_memory)
        elif any(word in content for word in ["åŽ‹åŠ›", "ç„¦è™‘", "æ”¾æ¾", "stress", "å†¥æƒ³"]):
            topic = "mental"
            response = self._respond_mental(message, user_memory)
        elif any(word in content for word in ["é¢ˆæ¤Ž", "è…°", "ä¹…å", "çœ¼ç›"]):
            topic = "office"
            response = self._respond_office_health(message, user_memory)
        else:
            topic = "general"
            response = self._respond_general(message, interaction_count)
        
        # æ›´æ–°ç”¨æˆ·è®°å¿†
        user_memory["interaction_count"] = interaction_count + 1
        user_memory["last_topic"] = topic
        user_memory["health_goals"] = user_memory.get("health_goals", [])
        self.memory_write(message.user_id, user_memory)
        
        return AgentResponse(
            content=response,
            agent_name=self.name,
            confidence=0.85,
            metadata={"topic": topic},
            should_continue=False
        )
    
    def _respond_fitness(self, message: Message, user_memory: Dict) -> str:
        """è¿åŠ¨å¥èº«å“åº”"""
        return (
            "ðŸ’ª **è¿åŠ¨å¥èº«æŒ‡å¯¼**\n\n"
            "æˆ‘æ¥å¸®æ‚¨è§„åˆ’è¿åŠ¨æ–¹æ¡ˆï¼š\n\n"
            "**æ–°æ‰‹å…¥é—¨å»ºè®®ï¼š**\n"
            "â€¢ æ¯å‘¨è¿åŠ¨3-4æ¬¡ï¼Œæ¯æ¬¡30-60åˆ†é’Ÿ\n"
            "â€¢ æœ‰æ°§+åŠ›é‡è®­ç»ƒç›¸ç»“åˆ\n"
            "â€¢ å¾ªåºæ¸è¿›ï¼Œä¸è¦æ€¥äºŽæ±‚æˆ\n\n"
            "**è¿åŠ¨ç±»åž‹æŽ¨èï¼š**\n"
            "ðŸƒ æœ‰æ°§è¿åŠ¨ï¼šè·‘æ­¥ã€æ¸¸æ³³ã€éª‘è½¦ï¼ˆç‡ƒè„‚ï¼‰\n"
            "ðŸ‹ï¸ åŠ›é‡è®­ç»ƒï¼šæ·±è¹²ã€ä¿¯å§æ’‘ã€ç¡¬æ‹‰ï¼ˆå¢žè‚Œï¼‰\n"
            "ðŸ§˜ æŸ”éŸ§è®­ç»ƒï¼šç‘œä¼½ã€æ‹‰ä¼¸ï¼ˆæ¢å¤ï¼‰\n\n"
            "**é‡è¦æé†’ï¼š**\n"
            "â€¢ è¿åŠ¨å‰çƒ­èº«5-10åˆ†é’Ÿ\n"
            "â€¢ è¿åŠ¨åŽæ‹‰ä¼¸æ”¾æ¾\n"
            "â€¢ ä¿è¯å……è¶³ç¡çœ å’Œè¥å…»\n"
            "â€¢ å¦‚æœ‰ä¸é€‚ç«‹å³åœæ­¢\n\n"
            "ðŸ“Š æ‚¨ç›®å‰çš„è¿åŠ¨åŸºç¡€å’Œç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"
        )
    
    def _respond_nutrition(self, message: Message, user_memory: Dict) -> str:
        """é¥®é£Ÿè¥å…»å“åº”"""
        return (
            "ðŸ¥— **å¥åº·é¥®é£ŸæŒ‡å—**\n\n"
            "ç§‘å­¦çš„é¥®é£Ÿæ˜¯å¥åº·çš„åŸºç¡€ï¼š\n\n"
            "**å‡è¡¡è¥å…»åŽŸåˆ™ï¼š**\n"
            "â€¢ ç¢³æ°´åŒ–åˆç‰©ï¼šå…¨è°·ç‰©ã€è”¬èœä¸ºä¸»\n"
            "â€¢ è›‹ç™½è´¨ï¼šé±¼è‚‰ã€ç¦½è‚‰ã€è±†ç±»ã€è›‹å¥¶\n"
            "â€¢ è„‚è‚ªï¼šåšæžœã€æ©„æ¦„æ²¹ç­‰ä¼˜è´¨è„‚è‚ª\n"
            "â€¢ è†³é£Ÿçº¤ç»´ï¼šè”¬èœã€æ°´æžœã€ç²—ç²®\n\n"
            "**æ¯æ—¥å»ºè®®ï¼š**\n"
            "ðŸ¥¦ è”¬èœï¼š400-500g\n"
            "ðŸŽ æ°´æžœï¼š200-350g\n"
            "ðŸš ä¸»é£Ÿï¼šé€‚é‡å…¨è°·ç‰©\n"
            "ðŸ¥› è›‹ç™½è´¨ï¼šæ¯é¤ä¸€æŽŒå¿ƒ\n"
            "ðŸ’§ é¥®æ°´ï¼š1.5-2å‡\n\n"
            "**é¥®é£Ÿä¹ æƒ¯å»ºè®®ï¼š**\n"
            "â€¢ ä¸‰é¤è§„å¾‹ï¼Œç»†åš¼æ…¢å’½\n"
            "â€¢ å°‘æ²¹å°‘ç›å°‘ç³–\n"
            "â€¢ é¿å…æ·±åŠ å·¥é£Ÿå“\n\n"
            "ðŸŽ¯ æ‚¨æƒ³æ”¹å–„å“ªæ–¹é¢çš„é¥®é£Ÿä¹ æƒ¯ï¼Ÿ"
        )
    
    def _respond_sleep(self, message: Message, user_memory: Dict) -> str:
        """ç¡çœ æ”¹å–„å“åº”"""
        return (
            "ðŸ˜´ **æ”¹å–„ç¡çœ è´¨é‡**\n\n"
            "è‰¯å¥½çš„ç¡çœ å¯¹å¥åº·è‡³å…³é‡è¦ï¼š\n\n"
            "**ç¡çœ çŽ¯å¢ƒä¼˜åŒ–ï¼š**\n"
            "â€¢ ä¿æŒå§å®¤å‡‰çˆ½ï¼ˆ18-22â„ƒï¼‰\n"
            "â€¢ ç¡®ä¿é»‘æš—å’Œå®‰é™\n"
            "â€¢ é€‰æ‹©èˆ’é€‚çš„åºŠåž«å’Œæž•å¤´\n"
            "â€¢ ç§»é™¤ç”µå­è®¾å¤‡å¹²æ‰°\n\n"
            "**ç¡å‰ä¹ æƒ¯å»ºè®®ï¼š**\n"
            "ðŸŒ™ ç¡å‰1å°æ—¶é¿å…è“å…‰\n"
            "â˜• ä¸‹åˆ4ç‚¹åŽé¿å…å’–å•¡å› \n"
            "ðŸ“µ ç¡å‰æ”¾ä¸‹æ‰‹æœº\n"
            "ðŸ› æ¸©æ°´æ³¡è„šæˆ–æ´—æ¾¡æ”¾æ¾\n"
            "ðŸ“– å¯ä»¥é˜…è¯»æˆ–å†¥æƒ³\n\n"
            "**ä½œæ¯å»ºè®®ï¼š**\n"
            "â€¢ å›ºå®šç¡çœ å’Œèµ·åºŠæ—¶é—´\n"
            "â€¢ æ¯å¤©ä¿è¯7-9å°æ—¶ç¡çœ \n"
            "â€¢ é¿å…å‘¨æœ«è¡¥è§‰è¿‡å¤š\n\n"
            "âš ï¸ å¦‚æžœæŒç»­å¤±çœ è¶…è¿‡2å‘¨ï¼Œå»ºè®®å°±åŒ»æ£€æŸ¥ã€‚\n\n"
            "æ‚¨ç›®å‰çš„ç¡çœ é—®é¢˜ä¸»è¦æ˜¯ä»€ä¹ˆï¼Ÿ"
        )
    
    def _respond_mental(self, message: Message, user_memory: Dict) -> str:
        """å¿ƒç†å¥åº·å“åº”"""
        return (
            "ðŸ§˜ **åŽ‹åŠ›ç®¡ç†ä¸Žå¿ƒç†è°ƒèŠ‚**\n\n"
            "å…³æ³¨å¿ƒç†å¥åº·åŒæ ·é‡è¦ï¼š\n\n"
            "**æ—¥å¸¸å‡åŽ‹æ–¹æ³•ï¼š**\n"
            "â€¢ ðŸŒ¬ï¸ æ·±å‘¼å¸ç»ƒä¹ ï¼š4-7-8å‘¼å¸æ³•\n"
            "â€¢ ðŸ§˜ å†¥æƒ³ï¼šæ¯å¤©10-15åˆ†é’Ÿ\n"
            "â€¢ ðŸš¶ æ•£æ­¥ï¼šæˆ·å¤–æ´»åŠ¨æ”¾æ¾èº«å¿ƒ\n"
            "â€¢ âœï¸ å†™æ—¥è®°ï¼šè®°å½•æ„Ÿå—å’Œæƒ³æ³•\n"
            "â€¢ ðŸŽµ å¬éŸ³ä¹ï¼šèˆ’ç¼“çš„éŸ³ä¹ç–—æ„ˆ\n\n"
            "**å¥åº·å¿ƒæ€åŸ¹å…»ï¼š**\n"
            "â€¢ æŽ¥å—ä¸å®Œç¾Ž\n"
            "â€¢ ä¸“æ³¨å½“ä¸‹\n"
            "â€¢ ä¸Žäº²å‹ä¿æŒè”ç³»\n"
            "â€¢ è®¾å®šåˆç†çš„æœŸæœ›\n"
            "â€¢ å­¦ä¼šè¯´'ä¸'\n\n"
            "**4-7-8å‘¼å¸æ³•ï¼š**\n"
            "å¸æ°”4ç§’ â†’ å±æ¯7ç§’ â†’ å‘¼æ°”8ç§’\n"
            "é‡å¤3-4æ¬¡ï¼Œæœ‰åŠ©äºŽå¿«é€Ÿæ”¾æ¾\n\n"
            "ðŸ’™ å¦‚æžœæŒç»­æ„Ÿåˆ°ç„¦è™‘æˆ–æŠ‘éƒï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¿ƒç†å¸®åŠ©ã€‚\n\n"
            "æ‚¨æƒ³å°è¯•å“ªç§æ”¾æ¾æ–¹å¼ï¼Ÿ"
        )
    
    def _respond_office_health(self, message: Message, user_memory: Dict) -> str:
        """åŠžå…¬å®¤å¥åº·å“åº”"""
        return (
            "ðŸ’¼ **ä¹…ååŠžå…¬å¥åº·æŒ‡å—**\n\n"
            "é•¿æ—¶é—´åç€å·¥ä½œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š\n\n"
            "**é¢ˆæ¤Žä¿æŠ¤ï¼š**\n"
            "â€¢ å±å¹•ä¸Žçœ¼ç›å¹³é½\n"
            "â€¢ æ¯1å°æ—¶æ´»åŠ¨é¢ˆéƒ¨\n"
            "â€¢ åšé¢ˆéƒ¨æ—‹è½¬å’Œä¾§å±ˆ\n\n"
            "**è…°éƒ¨ä¿æŠ¤ï¼š**\n"
            "â€¢ åå§¿ä¿æŒè…°éƒ¨æ”¯æ’‘\n"
            "â€¢ ç«™èµ·æ¥èµ°åŠ¨ä¼‘æ¯\n"
            "â€¢ åšè…°éƒ¨æ‹‰ä¼¸è¿åŠ¨\n\n"
            "**çœ¼ç›ä¿æŠ¤ï¼ˆ20-20-20æ³•åˆ™ï¼‰ï¼š**\n"
            "æ¯20åˆ†é’Ÿ â†’ çœ‹20è‹±å°ºå¤– â†’ 20ç§’\n\n"
            "**åŠžå…¬å®¤æ‹‰ä¼¸åŠ¨ä½œï¼š**\n"
            "1ï¸âƒ£ è‚©éƒ¨çŽ¯ç»•\n"
            "2ï¸âƒ£ èƒ¸éƒ¨æ‰©å±•\n"
            "3ï¸âƒ£ åå§¿è½¬ä½“\n"
            "4ï¸âƒ£ æ‰‹è…•ä¼¸å±•\n"
            "5ï¸âƒ£ ç«™èµ·æ¥æ·±è¹²\n\n"
            "â° è®¾ç½®æé†’æ¯å°æ—¶èµ·æ¥æ´»åŠ¨2-3åˆ†é’Ÿã€‚\n\n"
            "æ‚¨ä¸»è¦æ˜¯å“ªä¸ªéƒ¨ä½ä¸èˆ’æœï¼Ÿ"
        )
    
    def _respond_general(self, message: Message, interaction_count: int) -> str:
        """é€šç”¨å¥åº·å“åº”"""
        if interaction_count == 0:
            return (
                "ðŸ¥ **æ¬¢è¿Žå’¨è¯¢å¥åº·ç”Ÿæ´»æœåŠ¡**\n\n"
                "æˆ‘æ˜¯æ‚¨çš„å¥åº·ç”Ÿæ´»é¡¾é—®ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š\n\n"
                "ðŸ’ª è¿åŠ¨å¥èº«\n"
                "â€¢ åˆ¶å®šè¿åŠ¨è®¡åˆ’\n"
                "â€¢ å¥èº«æŒ‡å¯¼å»ºè®®\n\n"
                "ðŸ¥— é¥®é£Ÿè¥å…»\n"
                "â€¢ å¥åº·é¥®é£ŸæŒ‡å¯¼\n"
                "â€¢ è¥å…»çŸ¥è¯†ç§‘æ™®\n\n"
                "ðŸ˜´ ç¡çœ æ”¹å–„\n"
                "â€¢ å¤±çœ é—®é¢˜è°ƒèŠ‚\n"
                "â€¢ ç¡çœ ä¹ æƒ¯ä¼˜åŒ–\n\n"
                "ðŸ§˜ å¿ƒç†å¥åº·\n"
                "â€¢ åŽ‹åŠ›ç®¡ç†\n"
                "â€¢ æ”¾æ¾æŠ€å·§\n\n"
                "è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆå¥åº·è¯é¢˜ï¼Ÿ"
            )
        else:
            return (
                "ðŸŒ¿ æˆ‘éšæ—¶å‡†å¤‡ä¸ºæ‚¨è§£ç­”å¥åº·ç”Ÿæ´»é—®é¢˜ã€‚\n\n"
                "æ— è®ºæ˜¯è¿åŠ¨å¥èº«ã€é¥®é£Ÿè¥å…»ã€ç¡çœ æ”¹å–„ï¼Œ"
                "è¿˜æ˜¯åŽ‹åŠ›ç®¡ç†ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘äº¤æµã€‚\n\n"
                "âš ï¸ æ¸©é¦¨æé†’ï¼šå¦‚æœ‰ä¸¥é‡ç—‡çŠ¶ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚\n\n"
                "è¯·é—®æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ"
            )
    
    def memory_read(self, user_id: str) -> Dict[str, Any]:
        return self._memory.read(self.name, user_id)
    
    def memory_write(self, user_id: str, data: Dict[str, Any]) -> None:
        self._memory.write(self.name, user_id, data)
