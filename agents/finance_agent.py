"""
é‡‘èžç†è´¢Agent

æä¾›é‡‘èžæŠ•èµ„ã€ç†è´¢è§„åˆ’ã€å¸‚åœºåˆ†æžç­‰ä¸“ä¸šå’¨è¯¢æœåŠ¡ã€‚
è¿™æ˜¯ä¸€ä¸ªå…·æœ‰é«˜å•†ä¸šä»·å€¼çš„Agentï¼Œå¯å¯¹æŽ¥é‡‘èžAPIå’ŒLLMã€‚
"""
from typing import Dict, Any, Optional
from datetime import datetime
from src.agents import BaseAgent, Message, ChatContext, AgentResponse, SQLiteMemoryStore


class FinanceAgent(BaseAgent):
    """
    é‡‘èžç†è´¢Agent - æä¾›ä¸“ä¸šé‡‘èžå’¨è¯¢
    
    ä¸“é•¿é¢†åŸŸ:
    - æŠ•èµ„ç†è´¢ï¼šè‚¡ç¥¨ã€åŸºé‡‘ã€å€ºåˆ¸å’¨è¯¢
    - å¸‚åœºåˆ†æžï¼šè¡Œæƒ…èµ°åŠ¿ã€æŠ•èµ„å»ºè®®
    - ä¸ªäººè´¢åŠ¡ï¼šé¢„ç®—ç®¡ç†ã€å‚¨è“„è§„åˆ’
    - åŠ å¯†è´§å¸ï¼šæ•°å­—èµ„äº§å’¨è¯¢
    
    é€‚ç”¨åœºæ™¯:
    - "å¸®æˆ‘åˆ†æžä¸€ä¸‹è¿‘æœŸçš„è‚¡å¸‚èµ°åŠ¿"
    - "æˆ‘è¯¥å¦‚ä½•è§„åˆ’é€€ä¼‘é‡‘ï¼Ÿ"
    - "ä»‹ç»ä¸€äº›é€‚åˆæ–°æ‰‹çš„ç†è´¢äº§å“"
    """
    
    def __init__(self, memory_store=None, llm_provider=None):
        """
        åˆå§‹åŒ–é‡‘èžç†è´¢Agent
        
        Args:
            memory_store: è®°å¿†å­˜å‚¨å®žä¾‹
            llm_provider: LLMæä¾›è€…ï¼ˆç”¨äºŽç”Ÿæˆä¸“ä¸šå›žå¤ï¼‰
        """
        self._name = "FinanceAgent"
        self._description = (
            "æä¾›é‡‘èžç†è´¢å’¨è¯¢å’ŒæŠ•èµ„å»ºè®®ã€‚"
            "æ¶µç›–è‚¡ç¥¨ã€åŸºé‡‘ã€ä¸ªäººè´¢åŠ¡è§„åˆ’ç­‰é¢†åŸŸï¼Œ"
            "å¸®åŠ©ç”¨æˆ·åšå‡ºæ˜Žæ™ºçš„è´¢åŠ¡å†³ç­–ã€‚"
        )
        self._memory = memory_store or SQLiteMemoryStore()
        self._llm_provider = llm_provider
        
        # é‡‘èžç›¸å…³å…³é”®è¯
        self._finance_keywords = [
            # æŠ•èµ„ç±»
            "è‚¡ç¥¨", "åŸºé‡‘", "å€ºåˆ¸", "æŠ•èµ„", "ç†è´¢", "è¯åˆ¸",
            "stock", "fund", "bond", "invest", "investment",
            "portfolio", "dividend", "æ”¶ç›Š", "å›žæŠ¥", "åˆ†çº¢",
            
            # å¸‚åœºç±»
            "è¡Œæƒ…", "èµ°åŠ¿", "æ¶¨", "è·Œ", "ç‰›å¸‚", "ç†Šå¸‚",
            "market", "bull", "bear", "trend", "analysis",
            
            # ä¸ªäººè´¢åŠ¡
            "å‚¨è“„", "é¢„ç®—", "é€€ä¼‘", "ä¿é™©", "è´·æ¬¾", "æˆ¿è´·",
            "savings", "budget", "retirement", "insurance", "loan", "mortgage",
            
            # åŠ å¯†è´§å¸
            "æ¯”ç‰¹å¸", "ä»¥å¤ªåŠ", "åŠ å¯†è´§å¸", "æ•°å­—è´§å¸", "å¸åœˆ",
            "bitcoin", "ethereum", "crypto", "cryptocurrency", "blockchain",
            
            # è´¢åŠ¡è§„åˆ’
            "ç†è´¢è§„åˆ’", "è´¢åŠ¡è‡ªç”±", "èµ„äº§é…ç½®", "é£Žé™©ç®¡ç†",
            "financial planning", "wealth", "asset allocation",
        ]
        
        # ç³»ç»Ÿæç¤ºè¯
        self._system_prompt = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‡‘èžç†è´¢é¡¾é—®ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æŠ•èµ„ç»éªŒå’Œè´¢åŠ¡è§„åˆ’çŸ¥è¯†ã€‚

ä½ çš„èŒè´£ï¼š
1. æä¾›ä¸“ä¸šçš„é‡‘èžçŸ¥è¯†å’ŒæŠ•èµ„å»ºè®®
2. è§£ç­”ç”¨æˆ·å…³äºŽè‚¡ç¥¨ã€åŸºé‡‘ã€å€ºåˆ¸ç­‰æŠ•èµ„äº§å“çš„é—®é¢˜
3. å¸®åŠ©ç”¨æˆ·è¿›è¡Œä¸ªäººè´¢åŠ¡è§„åˆ’
4. åˆ†æžå¸‚åœºè¶‹åŠ¿ï¼Œä½†è¦æ˜Žç¡®æŒ‡å‡ºæŠ•èµ„æœ‰é£Žé™©

é‡è¦åŽŸåˆ™ï¼š
- å§‹ç»ˆæé†’ç”¨æˆ·"æŠ•èµ„æœ‰é£Žé™©ï¼Œå…¥å¸‚éœ€è°¨æ…Ž"
- ä¸æä¾›å…·ä½“çš„ä¹°å…¥å–å‡ºå»ºè®®ï¼Œåªåšåˆ†æž
- å»ºè®®ç”¨æˆ·åœ¨é‡å¤§å†³ç­–å‰å’¨è¯¢æŒç‰Œç†è´¢é¡¾é—®
- ä½¿ç”¨ä¸“ä¸šä½†æ˜“æ‡‚çš„è¯­è¨€

å›žå¤é£Žæ ¼ï¼š
- ä¸“ä¸šã€ä¸¥è°¨ã€å®¢è§‚
- é€‚å½“ä½¿ç”¨é‡‘èžæœ¯è¯­ä½†è¦è§£é‡Šæ¸…æ¥š
- æä¾›å®žç”¨çš„å»ºè®®å’Œæ€è·¯"""

    @property
    def name(self) -> str:
        return self._name
    
    @property
    def description(self) -> str:
        return self._description
    
    def can_handle(self, message: Message, context: ChatContext) -> float:
        """åˆ¤æ–­æ˜¯å¦èƒ½å¤„ç†æ­¤æ¶ˆæ¯"""
        if message.has_mention(self.name):
            return 1.0
        
        content = message.content.lower()
        
        # ç»Ÿè®¡å…³é”®è¯åŒ¹é…
        keyword_matches = sum(1 for kw in self._finance_keywords if kw in content)
        
        if keyword_matches >= 3:
            return 0.9
        elif keyword_matches == 2:
            return 0.75
        elif keyword_matches == 1:
            return 0.55
        
        return 0.0
    
    def respond(self, message: Message, context: ChatContext) -> AgentResponse:
        """ç”Ÿæˆé‡‘èžå’¨è¯¢å›žå¤"""
        user_memory = self.memory_read(message.user_id)
        interaction_count = user_memory.get("interaction_count", 0)
        
        content = message.get_clean_content().lower()
        
        # è¯†åˆ«ä¸»é¢˜å¹¶ç”Ÿæˆå“åº”
        if any(word in content for word in ["è‚¡ç¥¨", "stock", "è¯åˆ¸"]):
            topic = "stock"
            response = self._respond_stock(message, user_memory)
        elif any(word in content for word in ["åŸºé‡‘", "fund", "å®šæŠ•"]):
            topic = "fund"
            response = self._respond_fund(message, user_memory)
        elif any(word in content for word in ["ç†è´¢", "å‚¨è“„", "é¢„ç®—", "è§„åˆ’"]):
            topic = "planning"
            response = self._respond_planning(message, user_memory)
        elif any(word in content for word in ["æ¯”ç‰¹å¸", "åŠ å¯†", "crypto", "bitcoin"]):
            topic = "crypto"
            response = self._respond_crypto(message, user_memory)
        else:
            topic = "general"
            response = self._respond_general(message, interaction_count)
        
        # æ›´æ–°ç”¨æˆ·è®°å¿†
        user_memory["interaction_count"] = interaction_count + 1
        user_memory["last_topic"] = topic
        user_memory["last_query"] = message.content[:100]
        self.memory_write(message.user_id, user_memory)
        
        return AgentResponse(
            content=response,
            agent_name=self.name,
            confidence=0.85,
            metadata={"topic": topic},
            should_continue=False
        )
    
    def _respond_stock(self, message: Message, user_memory: Dict) -> str:
        """è‚¡ç¥¨ç›¸å…³å“åº”"""
        return (
            "ðŸ“ˆ **è‚¡ç¥¨æŠ•èµ„å’¨è¯¢**\n\n"
            "å…³äºŽæ‚¨çš„è‚¡ç¥¨é—®é¢˜ï¼Œæˆ‘æ¥ä¸ºæ‚¨åˆ†æžï¼š\n\n"
            "**æŠ•èµ„è‚¡ç¥¨å‰éœ€è¦è€ƒè™‘çš„å› ç´ ï¼š**\n"
            "1. å…¬å¸åŸºæœ¬é¢åˆ†æžï¼ˆè´¢æŠ¥ã€è¡Œä¸šåœ°ä½ï¼‰\n"
            "2. æŠ€æœ¯é¢åˆ†æžï¼ˆä»·æ ¼èµ°åŠ¿ã€æˆäº¤é‡ï¼‰\n"
            "3. å®è§‚ç»æµŽçŽ¯å¢ƒ\n"
            "4. ä¸ªäººé£Žé™©æ‰¿å—èƒ½åŠ›\n\n"
            "**å»ºè®®æ­¥éª¤ï¼š**\n"
            "â€¢ å…ˆäº†è§£ç›®æ ‡å…¬å¸çš„ä¸šåŠ¡æ¨¡å¼\n"
            "â€¢ åˆ†æžè¿‘å‡ å¹´çš„è´¢åŠ¡æ•°æ®\n"
            "â€¢ è¯„ä¼°å½“å‰ä¼°å€¼æ˜¯å¦åˆç†\n"
            "â€¢ åˆ¶å®šæŠ•èµ„è®¡åˆ’å’Œæ­¢æŸç­–ç•¥\n\n"
            "âš ï¸ **é£Žé™©æç¤º**ï¼šè‚¡å¸‚æœ‰é£Žé™©ï¼ŒæŠ•èµ„éœ€è°¨æ…Žã€‚"
            "å»ºè®®æ‚¨åœ¨åšé‡å¤§æŠ•èµ„å†³ç­–å‰å’¨è¯¢ä¸“ä¸šçš„æŒç‰Œç†è´¢é¡¾é—®ã€‚\n\n"
            "æ‚¨æƒ³äº†è§£å“ªæ–¹é¢çš„æ›´å¤šç»†èŠ‚ï¼Ÿ"
        )
    
    def _respond_fund(self, message: Message, user_memory: Dict) -> str:
        """åŸºé‡‘ç›¸å…³å“åº”"""
        return (
            "ðŸ’¼ **åŸºé‡‘æŠ•èµ„æŒ‡å—**\n\n"
            "åŸºé‡‘æ˜¯ä¸€ç§é€‚åˆæ™®é€šæŠ•èµ„è€…çš„å·¥å…·ï¼Œæˆ‘æ¥å¸®æ‚¨äº†è§£ï¼š\n\n"
            "**å¸¸è§åŸºé‡‘ç±»åž‹ï¼š**\n"
            "â€¢ è´§å¸åŸºé‡‘ï¼šé£Žé™©ä½Žï¼ŒæµåŠ¨æ€§å¥½\n"
            "â€¢ å€ºåˆ¸åŸºé‡‘ï¼šé£Žé™©é€‚ä¸­ï¼Œæ”¶ç›Šç¨³å®š\n"
            "â€¢ æ··åˆåŸºé‡‘ï¼šè‚¡å€ºæ­é…ï¼Œå¹³è¡¡é£Žé™©\n"
            "â€¢ è‚¡ç¥¨åŸºé‡‘ï¼šæ”¶ç›Šæ½œåŠ›å¤§ï¼Œé£Žé™©è¾ƒé«˜\n"
            "â€¢ æŒ‡æ•°åŸºé‡‘ï¼šè·Ÿè¸ªæŒ‡æ•°ï¼Œè´¹ç”¨ä½Žå»‰\n\n"
            "**å®šæŠ•ç­–ç•¥å»ºè®®ï¼š**\n"
            "1. é€‰æ‹©æ³¢åŠ¨è¾ƒå¤§çš„åŸºé‡‘æ›´é€‚åˆå®šæŠ•\n"
            "2. åšæŒé•¿æœŸæŠ•èµ„ï¼Œé¿å…é¢‘ç¹æ“ä½œ\n"
            "3. è®¾å®šç›®æ ‡æ”¶ç›ŠçŽ‡ï¼Œè¾¾åˆ°åŽé€‚å½“æ­¢ç›ˆ\n\n"
            "ðŸ“Š æ‚¨ç›®å‰çš„æŠ•èµ„ç›®æ ‡å’Œé£Žé™©åå¥½æ˜¯ä»€ä¹ˆï¼Ÿ"
            "æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›æ›´æœ‰é’ˆå¯¹æ€§çš„å»ºè®®ã€‚"
        )
    
    def _respond_planning(self, message: Message, user_memory: Dict) -> str:
        """ç†è´¢è§„åˆ’å“åº”"""
        return (
            "ðŸ“‹ **ä¸ªäººè´¢åŠ¡è§„åˆ’å»ºè®®**\n\n"
            "ç§‘å­¦çš„ç†è´¢è§„åˆ’æ˜¯å®žçŽ°è´¢åŠ¡è‡ªç”±çš„åŸºç¡€ï¼š\n\n"
            "**ç†è´¢å››æ­¥æ³•ï¼š**\n\n"
            "**1ï¸âƒ£ è®°è´¦ä¸Žé¢„ç®—**\n"
            "â€¢ äº†è§£æ”¶æ”¯æƒ…å†µ\n"
            "â€¢ åˆ¶å®šåˆç†é¢„ç®—\n"
            "â€¢ æŽ§åˆ¶éžå¿…è¦æ”¯å‡º\n\n"
            "**2ï¸âƒ£ å»ºç«‹åº”æ€¥åŸºé‡‘**\n"
            "â€¢ 3-6ä¸ªæœˆç”Ÿæ´»è´¹\n"
            "â€¢ æ”¾åœ¨è´§å¸åŸºé‡‘ç­‰æµåŠ¨æ€§å¥½çš„äº§å“\n\n"
            "**3ï¸âƒ£ ä¿é™©é…ç½®**\n"
            "â€¢ åŒ»ç–—é™©ã€æ„å¤–é™©ä¼˜å…ˆ\n"
            "â€¢ æ ¹æ®å®¶åº­æƒ…å†µé…ç½®å¯¿é™©\n\n"
            "**4ï¸âƒ£ æŠ•èµ„å¢žå€¼**\n"
            "â€¢ æ ¹æ®é£Žé™©åå¥½é€‰æ‹©äº§å“\n"
            "â€¢ åˆ†æ•£æŠ•èµ„ï¼Œå®šæœŸå¤ç›˜\n\n"
            "ðŸ’¡ æ‚¨çŽ°åœ¨å¤„äºŽå“ªä¸ªé˜¶æ®µï¼Ÿæˆ‘å¯ä»¥ç»™å‡ºæ›´å…·ä½“çš„å»ºè®®ã€‚"
        )
    
    def _respond_crypto(self, message: Message, user_memory: Dict) -> str:
        """åŠ å¯†è´§å¸å“åº”"""
        return (
            "ðŸ”— **åŠ å¯†è´§å¸æŠ•èµ„é¡»çŸ¥**\n\n"
            "åŠ å¯†è´§å¸æ˜¯é«˜é£Žé™©é«˜æ³¢åŠ¨çš„èµ„äº§ç±»åˆ«ï¼š\n\n"
            "**äº†è§£é£Žé™©ï¼š**\n"
            "â€¢ ä»·æ ¼æ³¢åŠ¨æžå¤§ï¼ˆå¯èƒ½ä¸€å¤©æ¶¨è·Œ20%+ï¼‰\n"
            "â€¢ ç›‘ç®¡æ”¿ç­–ä¸ç¡®å®šæ€§\n"
            "â€¢ æŠ€æœ¯é£Žé™©ï¼ˆç§é’¥ä¸¢å¤±ã€äº¤æ˜“æ‰€é£Žé™©ï¼‰\n"
            "â€¢ å¸‚åœºæ“çºµé£Žé™©\n\n"
            "**å¦‚æžœè¦å‚ä¸Žï¼Œå»ºè®®ï¼š**\n"
            "1. åªæŠ•å…¥èƒ½æ‰¿å—å…¨éƒ¨äºæŸçš„èµ„é‡‘\n"
            "2. æ·±å…¥äº†è§£åº•å±‚æŠ€æœ¯å’Œé¡¹ç›®\n"
            "3. ä½¿ç”¨å¯é çš„äº¤æ˜“å¹³å°\n"
            "4. å­¦ä¹ å®‰å…¨å­˜å‚¨æ–¹æ³•\n"
            "5. ä¸è¦è¿½æ¶¨æ€è·Œ\n\n"
            "âš ï¸ **é‡è¦æé†’**ï¼šåŠ å¯†è´§å¸ä¸é€‚åˆæ‰€æœ‰äººã€‚"
            "è¯·ç¡®ä¿æ‚¨å……åˆ†äº†è§£é£Žé™©åŽå†åšå†³å®šã€‚\n\n"
            "æ‚¨æƒ³äº†è§£ä»€ä¹ˆå…·ä½“é—®é¢˜ï¼Ÿ"
        )
    
    def _respond_general(self, message: Message, interaction_count: int) -> str:
        """é€šç”¨é‡‘èžå“åº”"""
        if interaction_count == 0:
            return (
                "ðŸ’° **æ¬¢è¿Žå’¨è¯¢é‡‘èžç†è´¢æœåŠ¡**\n\n"
                "æˆ‘æ˜¯æ‚¨çš„é‡‘èžç†è´¢é¡¾é—®ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š\n\n"
                "ðŸ“ˆ æŠ•èµ„å’¨è¯¢\n"
                "â€¢ è‚¡ç¥¨ã€åŸºé‡‘ã€å€ºåˆ¸åˆ†æž\n"
                "â€¢ æŠ•èµ„ç»„åˆå»ºè®®\n\n"
                "ðŸ“‹ è´¢åŠ¡è§„åˆ’\n"
                "â€¢ ä¸ªäººé¢„ç®—ç®¡ç†\n"
                "â€¢ é€€ä¼‘è§„åˆ’\n"
                "â€¢ ä¿é™©é…ç½®å»ºè®®\n\n"
                "ðŸ” å¸‚åœºåˆ†æž\n"
                "â€¢ å®è§‚ç»æµŽè§£è¯»\n"
                "â€¢ è¡Œä¸šè¶‹åŠ¿åˆ†æž\n\n"
                "è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ"
            )
        else:
            return (
                "ðŸ’¼ æˆ‘éšæ—¶å‡†å¤‡ä¸ºæ‚¨è§£ç­”é‡‘èžç†è´¢é—®é¢˜ã€‚\n\n"
                "æ— è®ºæ˜¯æŠ•èµ„ç­–ç•¥ã€ç†è´¢äº§å“ï¼Œè¿˜æ˜¯è´¢åŠ¡è§„åˆ’ï¼Œ"
                "éƒ½å¯ä»¥è·Ÿæˆ‘äº¤æµã€‚\n\n"
                "è¯·é—®æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ"
            )
    
    def memory_read(self, user_id: str) -> Dict[str, Any]:
        return self._memory.read(self.name, user_id)
    
    def memory_write(self, user_id: str, data: Dict[str, Any]) -> None:
        self._memory.write(self.name, user_id, data)
